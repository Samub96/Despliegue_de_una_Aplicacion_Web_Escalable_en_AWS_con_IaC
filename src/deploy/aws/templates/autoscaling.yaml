AWSTemplateFormatVersion: "2010-09-09"
Description: "Auto Scaling Group + Launch Configuration para la aplicaci贸n"

Parameters:
  ImageId:
    Type: AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>
    Default: /aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2
  InstanceType:
    Type: String
    Default: t3.micro
  KeyName:
    Type: AWS::EC2::KeyPair::KeyName
  SecurityGroupId:
    Type: String
  SubnetIds:
    Type: CommaDelimitedList
  DesiredCapacity:
    Type: Number
    Default: 2
  MinSize:
    Type: Number
    Default: 2
  MaxSize:
    Type: Number
    Default: 4
  TargetGroupArn:
    Type: String
  DBEndpoint:
    Type: String
  DBName:
    Type: String
    Default: appdb
  DBUser:
    Type: String
    Default: admin
  DBPassword:
    Type: String
    NoEcho: true

Resources:
  LaunchConfig:
    Type: AWS::AutoScaling::LaunchConfiguration
    Properties:
      ImageId: !Ref ImageId
      InstanceType: !Ref InstanceType
      KeyName: !Ref KeyName
      SecurityGroups:
        - !Ref SecurityGroupId
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          set -ex
          exec > >(tee /var/log/user-data.log|logger -t user-data -s 2>/dev/console) 2>&1

          yum update -y
          
          # Instalar Docker
          amazon-linux-extras install docker -y
          systemctl enable docker
          systemctl start docker
          usermod -a -G docker ec2-user
          
          # Instalar Docker Compose
          curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          chmod +x /usr/local/bin/docker-compose
          ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose
          
          yum install -y git curl

          HOME_DIR=/home/ec2-user
          REPO_DIR=$HOME_DIR/app

          # Clonar repo
          if [ ! -d "$REPO_DIR" ]; then
            cd $HOME_DIR
            sudo -u ec2-user git clone https://github.com/Samub96/Despliegue_de_una_Aplicacion_Web_Escalable_en_AWS_con_IaC/tree/aws app
            chown -R ec2-user:ec2-user $REPO_DIR
          else
            cd $REPO_DIR
            sudo -u ec2-user git pull || true
          fi

          # Crear configuraci贸n para producci贸n
          cd $REPO_DIR
          cat > .env <<ENV_FILE
          DB_HOST=${DBEndpoint}
          DB_NAME=${DBName}
          DB_USER=${DBUser}
          DB_PASSWORD=${DBPassword}
          JWT_SECRET=$(openssl rand -base64 32)
          NODE_ENV=production
          PORT=8080
          ENV_FILE
          chown ec2-user:ec2-user .env

          # Crear docker-compose para auto scaling
          cat > docker-compose.asg.yml <<DOCKER_COMPOSE
          version: '3.8'
          services:
            backend:
              build:
                context: ./src/backend
                dockerfile: Dockerfile
              container_name: ecommerce_backend_asg
              restart: always
              environment:
                - DB_HOST=${DBEndpoint}
                - DB_NAME=${DBName}
                - DB_USER=${DBUser}
                - DB_PASSWORD=${DBPassword}
                - DB_DIALECT=mysql
                - JWT_SECRET=$(openssl rand -base64 32)
                - PORT=8080
                - NODE_ENV=production
              ports:
                - "8080:8080"
              healthcheck:
                test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/api/health"]
                timeout: 10s
                retries: 5
                interval: 30s
              networks:
                - app-network
          
            frontend:
              build:
                context: ./src/frontend
                dockerfile: Dockerfile
              container_name: ecommerce_frontend_asg
              restart: always
              ports:
                - "80:80"
              depends_on:
                backend:
                  condition: service_healthy
              healthcheck:
                test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/health"]
                timeout: 10s
                retries: 3
                interval: 30s
              networks:
                - app-network
          
          networks:
            app-network:
              driver: bridge
          DOCKER_COMPOSE
          chown ec2-user:ec2-user docker-compose.asg.yml

          # Iniciar aplicaci贸n
          cd $REPO_DIR
          sudo -u ec2-user docker-compose -f docker-compose.asg.yml up --build -d

          # Auto-start service
          cat > /etc/systemd/system/ecommerce-asg.service <<SERVICE_FILE
          [Unit]
          Description=E-commerce ASG Application
          Requires=docker.service
          After=docker.service

          [Service]
          Type=oneshot
          RemainAfterExit=yes
          WorkingDirectory=$REPO_DIR
          ExecStart=/usr/local/bin/docker-compose -f docker-compose.asg.yml up -d
          ExecStop=/usr/local/bin/docker-compose -f docker-compose.asg.yml down
          TimeoutStartSec=0
          User=ec2-user

          [Install]
          WantedBy=multi-user.target
          SERVICE_FILE

          systemctl enable ecommerce-asg.service

          # Frontend
          if [ -d "$REPO_DIR/src/frontend" ]; then
            mkdir -p /usr/share/nginx/html
            rm -rf /usr/share/nginx/html/*
            cp -r $REPO_DIR/src/frontend/* /usr/share/nginx/html/
            chown -R nginx:nginx /usr/share/nginx/html
          fi

          # Nginx
          cat > /etc/nginx/conf.d/app.conf <<'NGINX_CONF'
          server {
            listen 80 default_server;
            server_name_;
            root /usr/share/nginx/html;
            index index.html;

            access_log /var/log/nginx/app_access.log;
            error_log /var/log/nginx/app_error.log;

            location /api/ {
              proxy_pass http://127.0.0.1:8080/;
              proxy_http_version 1.1;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
              
              proxy_connect_timeout 60s;
              proxy_send_timeout 60s;
              proxy_read_timeout 60s;
            }

            location / {
              try_files $uri $uri/ /index.html;
            }

            location /health {
              access_log off;
              return 200 "healthy\n";
              add_header Content-Type text/plain;
            }
          }
          NGINX_CONF

          rm -f /etc/nginx/conf.d/default.conf || true
          systemctl enable nginx
          systemctl restart nginx

          echo "Startup complete: $(date)" > $HOME_DIR/startup.log

  AutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      VPCZoneIdentifier: !Ref SubnetIds
      LaunchConfigurationName: !Ref LaunchConfig
      MinSize: !Ref MinSize
      MaxSize: !Ref MaxSize
      DesiredCapacity: !Ref DesiredCapacity
      TargetGroupARNs:
        - !Ref TargetGroupArn
      HealthCheckType: ELB
      HealthCheckGracePeriod: 300
      Tags:
        - Key: Name
          Value: app-asg-instance
          PropagateAtLaunch: true

Outputs:
  AutoScalingGroupName:
    Value: !Ref AutoScalingGroup
    Export:
      Name: project-asg-name
