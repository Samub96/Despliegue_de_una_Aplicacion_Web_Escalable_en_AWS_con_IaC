AWSTemplateFormatVersion: "2010-09-09"
Description: "EC2 base para ejecutar la aplicación (bastión + app) sin roles IAM (sandbox compatible)"

Parameters:
  VpcId:
    Type: String
  PublicSubnetIds:
    Type: CommaDelimitedList
  KeyName:
    Type: AWS::EC2::KeyPair::KeyName
  InstanceType:
    Type: String
    Default: t3.micro
  AmiId:
    Type: AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>
    Default: /aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2
  DBEndpoint:
    Type: String
  DBName:
    Type: String
    Default: appdb
  DBUser:
    Type: String
    Default: admin
  DBPassword:
    Type: String
    NoEcho: true

Resources:
  AppSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow HTTP and SSH
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: app-sg

  AppInstance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: !Ref InstanceType
      ImageId: !Ref AmiId
      KeyName: !Ref KeyName
      NetworkInterfaces:
        - AssociatePublicIpAddress: true
          DeviceIndex: 0
          SubnetId: !Select [0, !Ref PublicSubnetIds]
          GroupSet:
            - !Ref AppSecurityGroup

  # Sin IamInstanceProfile (bloqueado en sandbox)
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          set -ex
          exec > >(tee /var/log/user-data.log|logger -t user-data -s 2>/dev/console) 2>&1

          yum update -y
          
          # Instalar Docker
          amazon-linux-extras install docker -y
          systemctl enable docker
          systemctl start docker
          usermod -a -G docker ec2-user
          
          # Instalar Docker Compose
          curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          chmod +x /usr/local/bin/docker-compose
          ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose
          
          # Instalar git y otras herramientas
          yum install -y git curl
          
          HOME_DIR=/home/ec2-user
          REPO_DIR=$HOME_DIR/app

          # Clonar repositorio (rama aws)
          if [ ! -d "$REPO_DIR" ]; then
            cd $HOME_DIR
            sudo -u ec2-user git clone --branch aws --single-branch https://github.com/Samub96/Despliegue_de_una_Aplicacion_Web_Escalable_en_AWS_con_IaC.git app
            chown -R ec2-user:ec2-user $REPO_DIR
          else
            cd $REPO_DIR
            sudo -u ec2-user git pull || true
          fi

          # Crear configuración para producción
          cd $REPO_DIR
          
          # Actualizar .env del backend para producción
          cat > src/backend/.env <<ENV_FILE
          DB_NAME=${DBName}
          DB_USER=${DBUser}
          DB_PASSWORD=${DBPassword}
          DB_HOST=${DBEndpoint}
          JWT_SECRET=$(openssl rand -base64 32)
          DB_DIALECT=mysql
          PORT=8080
          ENV_FILE
          chown ec2-user:ec2-user src/backend/.env

          # Crear docker-compose para producción (sin MySQL, usa RDS)
          cat > docker-compose.prod.yml <<DOCKER_COMPOSE
          version: '3.8'

          services:
            # Backend API
            backend:
              build:
                context: ./src/backend
                dockerfile: Dockerfile
              container_name: ecommerce_backend
              restart: unless-stopped
              ports:
                - "8080:8080"
              environment:
                - NODE_ENV=production
              networks:
                - ecommerce_network
              healthcheck:
                test: ["CMD", "node", "-e", "require('http').get('http://localhost:8080', (r) => {if (r.statusCode !== 200) throw new Error(r.statusCode)})"]
                timeout: 10s
                retries: 5
                start_period: 30s

            # Frontend Web Server
            frontend:
              build:
                context: ./src/frontend
                dockerfile: Dockerfile
              container_name: ecommerce_frontend
              restart: unless-stopped
              ports:
                - "80:80"
              networks:
                - ecommerce_network
              depends_on:
                backend:
                  condition: service_healthy
              healthcheck:
                test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/"]
                timeout: 3s
                retries: 3
                start_period: 5s

          # Networks
          networks:
            ecommerce_network:
              driver: bridge
          DOCKER_COMPOSE
          chown ec2-user:ec2-user docker-compose.prod.yml

          # Construir e iniciar aplicación
          cd $REPO_DIR
          sudo -u ec2-user docker-compose -f docker-compose.prod.yml up --build -d

          # Esperar a que el backend esté listo y luego inicializar RDS
          echo "⏳ Esperando a que el backend esté listo..."
          sleep 30
          
          # Inicializar RDS con datos
          chmod +x src/deploy/aws/init-rds.sh
          ./src/deploy/aws/init-rds.sh "${DBEndpoint}" "${DBUser}" "${DBPassword}" "${DBName}"

          # Configurar auto-start en boot
          cat > /etc/systemd/system/ecommerce-app.service <<SERVICE_FILE
          [Unit]
          Description=E-commerce Application
          Requires=docker.service
          After=docker.service

          [Service]
          Type=oneshot
          RemainAfterExit=yes
          WorkingDirectory=$REPO_DIR
          ExecStart=/usr/local/bin/docker-compose -f docker-compose.prod.yml up -d
          ExecStop=/usr/local/bin/docker-compose -f docker-compose.prod.yml down
          TimeoutStartSec=0
          User=ec2-user

          [Install]
          WantedBy=multi-user.target
          SERVICE_FILE

          systemctl enable ecommerce-app.service

      Tags:
        - Key: Name
          Value: app-instance

Outputs:
  AppInstanceId:
    Value: !Ref AppInstance
    Export:
      Name: project-app-instance-id
  AppSecurityGroupId:
    Value: !Ref AppSecurityGroup
    Export:
      Name: project-app-sg-id
