AWSTemplateFormatVersion: "2010-09-09"
Description: "EC2 base para ejecutar la aplicaci√≥n (basti√≥n + app) sin roles IAM (sandbox compatible)"

Parameters:
  VpcId:
    Type: String
  PublicSubnetIds:
    Type: CommaDelimitedList
  KeyName:
    Type: AWS::EC2::KeyPair::KeyName
  InstanceType:
    Type: String
    Default: t3.micro
  AmiId:
    Type: AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>
    Default: /aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2
  DBEndpoint:
    Type: String
  DBName:
    Type: String
    Default: appdb
  DBUser:
    Type: String
    Default: admin
  DBPassword:
    Type: String
    NoEcho: true

Resources:
  AppSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow HTTP and SSH
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: app-sg

  AppInstance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: !Ref InstanceType
      ImageId: !Ref AmiId
      KeyName: !Ref KeyName
      NetworkInterfaces:
        - AssociatePublicIpAddress: true
          DeviceIndex: 0
          SubnetId: !Select [0, !Ref PublicSubnetIds]
          GroupSet:
            - !Ref AppSecurityGroup

      # üöÄ Sin IamInstanceProfile (bloqueado en sandbox)
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          set -ex
          exec > >(tee /var/log/user-data.log|logger -t user-data -s 2>/dev/console) 2>&1

          yum update -y
          amazon-linux-extras enable nginx1 2>/dev/null || true
          yum install -y nginx git gcc-c++ make curl
          curl -fsSL https://rpm.nodesource.com/setup_18.x | bash -
          yum install -y nodejs
          npm install -g pm2 --no-fund --no-audit

          HOME_DIR=/home/ec2-user
          REPO_DIR=$HOME_DIR/app

          if [ ! -d "$REPO_DIR" ]; then
            cd $HOME_DIR
            sudo -u ec2-user git clone https://github.com/Samub96/Despliegue_de_una_Aplicacion_Web_Escalable_en_AWS_con_IaC.git app
            chown -R ec2-user:ec2-user $REPO_DIR
          else
            cd $REPO_DIR
            sudo -u ec2-user git pull || true
          fi

          if [ -d "$REPO_DIR/src/backend" ]; then
            cd $REPO_DIR/src/backend
            cat > .env <<ENV_FILE
          DB_HOST=${DBEndpoint}
          DB_PORT=5432
          DB_NAME=${DBName}
          DB_USER=${DBUser}
          DB_PASSWORD=${DBPassword}
          JWT_SECRET=$(openssl rand -base64 32)
          NODE_ENV=production
          PORT=8080
          ENV_FILE
            chown ec2-user:ec2-user .env
            chmod 600 .env
            sudo -u ec2-user npm install --production
            sudo -u ec2-user pm2 start server.js --name backend --update-env
            sudo -u ec2-user pm2 startup systemd -u ec2-user --hp /home/ec2-user
            sudo -u ec2-user pm2 save
          fi

          if [ -d "$REPO_DIR/src/frontend" ]; then
            mkdir -p /usr/share/nginx/html
            rm -rf /usr/share/nginx/html/*
            cp -r $REPO_DIR/src/frontend/* /usr/share/nginx/html/
            chown -R nginx:nginx /usr/share/nginx/html
          fi

          cat > /etc/nginx/conf.d/app.conf <<'NGINX_CONF'
          server {
            listen 80 default_server;
            server_name _;
            root /usr/share/nginx/html;
            index index.html;
            location /api/ {
              proxy_pass http://127.0.0.1:8080/;
              proxy_http_version 1.1;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
            }
            location / { try_files $uri $uri/ /index.html; }
            location /health { return 200 "healthy\n"; add_header Content-Type text/plain; }
          }
          NGINX_CONF

          rm -f /etc/nginx/conf.d/default.conf || true
          systemctl enable nginx
          systemctl restart nginx

      Tags:
        - Key: Name
          Value: app-instance

Outputs:
  AppInstanceId:
    Value: !Ref AppInstance
    Export:
      Name: project-app-instance-id
  AppSecurityGroupId:
    Value: !Ref AppSecurityGroup
    Export:
      Name: project-app-sg-id
