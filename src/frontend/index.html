<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Mi Tienda - Cat√°logo</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <div class="container header-nav">
      <h1>Mi Tienda</h1>
      <nav>
        <a class="btn" href="cart.html">Carrito</a>
        <a class="btn" href="login.html" onclick="logout()">Salir</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <h2>Productos</h2>
    <div id="products" class="products"></div>
    <p id="message" style="margin-top:12px;color:#b00;text-align:center;"></p>
  </main>

  <script>
    const API_URL = 'http://localhost:8080/api/products';
    const CART_URL = 'http://localhost:8080/api/cart';
    const token = localStorage.getItem('token');
    const productsContainer = document.getElementById('products');
    const message = document.getElementById('message');

    // üö™ Logout
    function logout() {
      localStorage.removeItem('token');
    }

    // üõçÔ∏è Cargar productos
    async function loadProducts() {
      try {
        const res = await fetch(API_URL);
        if (!res.ok) throw new Error('Error al cargar productos');
        const data = await res.json();

        productsContainer.innerHTML = data.map(p => `
          <div class="product" style="border:1px solid #ddd;padding:15px;margin:10px;text-align:center;">
            <img src="${p.image}" alt="${p.name}" style="max-width:100%;height:150px;object-fit:cover;">
            <h3>${p.name}</h3>
            <p>${p.description}</p>
            <p><strong>$${p.price.toFixed(2)}</strong></p>
            <button class="btn" onclick="addToCart(${p.id})">Agregar al carrito</button>
          </div>
        `).join('');
      } catch (err) {
        console.error(err);
        message.textContent = '‚ùå Error al cargar productos.';
      }
    }

    // üõí Agregar producto al carrito
    async function addToCart(productId) {
      if (!token) {
        alert('‚ö†Ô∏è Debes iniciar sesi√≥n para agregar productos al carrito.');
        window.location.href = 'login.html';
        return;
      }

      try {
        const res = await fetch(`${CART_URL}/${productId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: 'Bearer ' + token
          }
        });

        const data = await res.json();
        if (res.ok) {
          alert('‚úÖ Producto agregado al carrito.');
        } else {
          alert(data.message || '‚ùå Error al agregar al carrito.');
        }
      } catch (err) {
        console.error(err);
        alert('üö´ Error al conectar con el servidor.');
      }
    }

    loadProducts();
  </script>
</body>
</html>